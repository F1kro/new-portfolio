---
import MainLayout from '../../layouts/MainLayout.astro';
import { supabase } from '../../lib/supabase';

const { slug } = Astro.params;

// 1. Ambil Data Project Utama
const { data: project, error } = await supabase
  .from('projects')
  .select('*')
  .eq('slug', slug)
  .single();

if (error || !project) {
  return Astro.redirect('/404');
}

// 2. Ambil Project Sebelumnya (Created At < Current Created At)
const { data: prevProject } = await supabase
  .from('projects')
  .select('title, slug')
  .lt('created_at', project.created_at)
  .order('created_at', { ascending: false })
  .limit(1)
  .single();

// 3. Ambil Project Selanjutnya (Created At > Current Created At)
const { data: nextProject } = await supabase
  .from('projects')
  .select('title, slug')
  .gt('created_at', project.created_at)
  .order('created_at', { ascending: true })
  .limit(1)
  .single();
---

<MainLayout title={`${project.title} | Project Detail`}>
  <article class="max-w-4xl mx-auto text-white animate-fade-in relative z-10">
    
    <div class="mb-8">
      <a href="/projects" class="inline-flex items-center gap-2 px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-[10px] font-mono text-slate-300 hover:text-white hover:bg-white/10 transition-all uppercase tracking-widest">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        Back to projects
      </a>
    </div>

    <div class="flex items-center gap-4 text-[9px] font-mono text-slate-500 mb-4 uppercase tracking-[0.2em]">
      <span class="flex items-center gap-1.5">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
        {project.date}
      </span>
    </div>

    <h1 class="text-3xl md:text-6xl font-black mb-4 tracking-tighter font-josefin leading-none uppercase">
      {project.title}
    </h1>
    <p class="text-[14px] md:text-lg text-slate-400 leading-relaxed mb-8 font-light italic">
      "{project.description}"
    </p>

    <div class="border border-white/10 rounded-xl overflow-hidden mb-6 shadow-2xl bg-white/5">
       <img src={project.image_url} alt={project.title} class="w-full h-auto object-cover" onerror="this.src='/projects/default.png'"/>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-10">
       {project.demo_url && (
         <a href={project.demo_url} target="_blank" class="flex items-center justify-center gap-2 px-3 py-2.5 bg-white/5 border border-white/10 rounded-lg text-[9px] font-bold text-white hover:bg-blue-500/20 hover:border-blue-500/50 transition-all uppercase tracking-widest">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path></svg>
            See Demo
         </a>
       )}
       {project.repo_url && (
         <a href={project.repo_url} target="_blank" class="flex items-center justify-center gap-2 px-3 py-2.5 bg-white/5 border border-white/10 rounded-lg text-[9px] font-bold text-white hover:bg-purple-500/20 hover:border-purple-500/50 transition-all uppercase tracking-widest">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
            Repository
         </a>
       )}
    </div>

    <div class="prose-custom space-y-12 mb-16 text-slate-300 leading-relaxed text-justify text-[13px] md:text-[15px]">
        <Fragment set:html={project.content} />
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-16 border-t border-white/5 pt-10">
      {prevProject ? (
        <a href={`/projects/${prevProject.slug}`} class="group p-5 bg-white/5 border border-white/10 rounded-xl flex items-center gap-4 hover:border-blue-500/30 transition-all">
          <div class="text-slate-600 text-xs group-hover:-translate-x-1 transition-transform">←</div>
          <div>
            <p class="text-[8px] font-mono text-slate-600 uppercase tracking-widest">Previous Project</p>
            <h4 class="text-xs font-bold text-white group-hover:text-blue-400 transition-colors uppercase mt-1">{prevProject.title}</h4>
          </div>
        </a>
      ) : <div class="hidden md:block"></div>}

      {nextProject ? (
        <a href={`/projects/${nextProject.slug}`} class="group p-5 bg-white/5 border border-white/10 rounded-xl flex items-center justify-end text-right gap-4 hover:border-blue-500/30 transition-all">
          <div>
            <p class="text-[8px] font-mono text-slate-600 uppercase tracking-widest">Next Project</p>
            <h4 class="text-xs font-bold text-white group-hover:text-blue-400 transition-colors uppercase mt-1">{nextProject.title}</h4>
          </div>
          <div class="text-slate-600 text-xs group-hover:translate-x-1 transition-transform">→</div>
        </a>
      ) : <div class="hidden md:block"></div>}
    </div>

    <div class="flex justify-center mt-10">
      <button onclick="window.scrollTo({top:0, behavior:'smooth'})" class="px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-[9px] font-mono text-slate-600 hover:text-white transition-all uppercase tracking-widest">
        ↑ Back to top
      </button>
    </div>
  </article>
</MainLayout>

<style is:global>
  .prose-custom p { @apply mb-6; }
  .prose-custom h2 { @apply text-xl md:text-2xl font-bold tracking-tight font-josefin uppercase mt-12 mb-6 text-white; }
  .prose-custom code { @apply bg-[#0d1117] border border-white/10 p-4 rounded-xl font-mono text-[11px] text-blue-300 block overflow-x-auto my-6; }
</style>