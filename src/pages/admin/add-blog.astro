---
import MainLayout from "../../layouts/MainLayout.astro";
---
<MainLayout title="Admin | Add Blog">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  
  <section class="relative z-10 max-w-4xl mx-auto px-6 py-20 text-white">
    <h1 class="text-3xl font-bold uppercase mb-8">Create New Post</h1>

    <form id="blogForm" class="card space-y-6 border-white/10 bg-black/40 backdrop-blur-md p-8">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <input type="text" name="title" placeholder="BLOG TITLE" class="input-style" required />
        <input type="text" name="slug" placeholder="SLUG (e.g. cara-hack-wifi)" class="input-style" required />
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <input type="text" name="category" placeholder="CATEGORY (TECH/CYBER)" class="input-style" />
        <div class="flex flex-col gap-2">
            <label class="text-[9px] font-mono text-slate-500 uppercase ml-1">Cover Image File</label>
            <input type="file" id="imageFile" accept="image/*" class="file-input-style" />
        </div>
      </div>

      <div class="space-y-2">
          <label class="text-[9px] font-mono text-slate-500 uppercase ml-1">Short Description</label>
          <textarea name="description" placeholder="Brief summary for the blog list..." rows="2" class="input-style h-20 resize-none"></textarea>
      </div>

      <div class="space-y-2">
        <label class="text-[9px] font-mono text-slate-500 uppercase ml-1">Full Content</label>
        <div id="editor" class="bg-white/5 border border-white/10 rounded-lg min-h-[400px]"></div>
      </div>

      <button type="submit" id="submitBtn" class="w-full py-4 bg-white text-black font-bold text-[10px] uppercase tracking-[0.3em] rounded-lg hover:bg-blue-600 hover:text-white transition-all">
        Publish to Universe
      </button>
    </form>
  </section>
</MainLayout>

<script>
  import { supabase } from "../../lib/supabase";
  import Quill from "quill";

  const quill = new Quill('#editor', { theme: 'snow', modules: { toolbar: [['bold', 'italic'], ['code-block', 'image', 'link']] } });
  const form = document.getElementById('blogForm') as HTMLFormElement;
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.innerText = "UPLOADING ASSETS...";

    const formData = new FormData(form);
    const imageFile = (document.getElementById('imageFile') as HTMLInputElement).files?.[0];
    let finalImageUrl = "";

    if (imageFile) {
      const fileExt = imageFile.name.split('.').pop();
      const fileName = `${Math.random()}.${fileExt}`;
      const filePath = `blog-covers/${fileName}`;

      const { data: uploadData, error: uploadError } = await supabase.storage
        .from('portfolio-assets')
        .upload(filePath, imageFile);

      if (uploadError) {
        alert("Gagal Upload Gambar: " + uploadError.message);
        submitBtn.disabled = false;
        return;
      }

      const { data: urlData } = supabase.storage
        .from('portfolio-assets')
        .getPublicUrl(filePath);
      
      finalImageUrl = urlData.publicUrl;
    }

    // --- SAVE KE DATABASE (Sekarang pake Description) ---
    const { error: dbError } = await supabase.from('blogs').insert([{
      title: formData.get('title'),
      slug: formData.get('slug'),
      category: (formData.get('category') as string)?.toUpperCase(),
      description: formData.get('description'), // FIELD INI SEKARANG ADA
      image_url: finalImageUrl,
      content: quill.root.innerHTML,
      date: new Date().toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: 'numeric' }).toUpperCase()
    }]);

    if (dbError) {
      alert("Database Error: " + dbError.message);
      submitBtn.disabled = false;
    } else {
      window.location.href = "/admin/dashboard";
    }
  });
  
  const titleInput = document.getElementsByName('title')[0] as HTMLInputElement;
  const slugInput = document.getElementsByName('slug')[0] as HTMLInputElement;
  
    titleInput?.addEventListener('input', () => {
      const slug = titleInput.value
        .toLowerCase()
        .trim()
        .replace(/[^\w\s-]/g, '') // Hapus karakter selain huruf, angka, spasi, dan strip
        .replace(/[\s_-]+/g, '-') // Ganti spasi/underscore jadi strip tunggal
        .replace(/^-+|-+$/g, ''); // Hapus strip di awal/akhir
      
      slugInput.value = slug;
    });
</script>

<style>
  .input-style { @apply w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-sm text-white outline-none focus:border-blue-500/50 transition-all placeholder:text-slate-700; }
  .file-input-style { @apply text-[10px] font-mono text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:bg-white/10 file:text-white hover:file:bg-white/20 transition-all; }
</style>