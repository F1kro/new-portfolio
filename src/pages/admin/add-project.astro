---
import MainLayout from "../../layouts/MainLayout.astro";
---
<MainLayout title="Admin | Add Project">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <section class="relative z-10 max-w-4xl mx-auto px-6 py-20 text-white">
    <div class="mb-10">
        <h1 class="text-3xl font-bold tracking-tight uppercase font-josefin">New Project</h1>
        <p class="text-[10px] tracking-[0.4em] text-slate-600 font-mono uppercase mt-2">Publishing to Portfolio Assets</p>
    </div>

    <form id="projectForm" class="space-y-6 border border-white/10 p-8 rounded-xl bg-black/40 backdrop-blur-sm">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-2">
            <label class="text-[9px] font-mono text-slate-500 uppercase ml-1 tracking-widest">Project Title</label>
            <input type="text" name="title" placeholder="E.G. SIAGOSIS APP" class="input-style" required />
        </div>
        <div class="space-y-2">
            <label class="text-[9px] font-mono text-slate-500 uppercase ml-1 tracking-widest">Slug (Auto)</label>
            <input type="text" name="slug" placeholder="siagosis-app" class="input-style" required />
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-2">
            <label class="text-[9px] font-mono text-slate-500 uppercase ml-1 tracking-widest">Date</label>
            <input type="text" name="date" placeholder="FEB 18, 2026" class="input-style" />
        </div>
        <div class="space-y-2">
            <label class="text-[9px] font-mono text-slate-500 uppercase ml-1 tracking-widest">Cover Image</label>
            <input type="file" id="imageInput" accept="image/*" class="file-input-style" />
        </div>
      </div>

      <div class="space-y-2">
        <label class="text-[9px] font-mono text-slate-500 uppercase ml-1 tracking-widest">Technologies (Comma Separated)</label>
        <input type="text" name="tags" placeholder="LARAVEL, TAILWIND, SUPABASE" class="input-style" />
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t border-white/5 pt-4">
        <div class="space-y-2">
            <label class="text-[9px] font-mono text-slate-500 uppercase ml-1 tracking-widest text-blue-400">Live Demo URL</label>
            <input type="url" name="demo_url" placeholder="https://demo.fiqro.dev" class="input-style border-blue-500/20" />
        </div>
        <div class="space-y-2">
            <label class="text-[9px] font-mono text-slate-500 uppercase ml-1 tracking-widest text-purple-400">Repository URL</label>
            <input type="url" name="repo_url" placeholder="https://github.com/masfiq/..." class="input-style border-purple-500/20" />
        </div>
      </div>

      <div class="space-y-2">
        <label class="text-[9px] font-mono text-slate-500 uppercase ml-1 tracking-widest">Short Description</label>
        <textarea name="description" placeholder="BRIEF OVERVIEW OF THE PROJECT..." rows="2" class="input-style resize-none"></textarea>
      </div>
      
      <div class="space-y-2">
        <label class="text-[10px] font-mono text-slate-500 uppercase tracking-widest ml-1">Full Documentation</label>
        <div id="editor" class="bg-white/5 border border-white/10 rounded-lg min-h-[300px]"></div>
      </div>

      <button type="submit" id="submitBtn" class="w-full py-4 bg-white text-black font-bold text-[10px] uppercase tracking-[0.3em] rounded-lg hover:bg-blue-600 hover:text-white transition-all active:scale-95">Upload Project</button>
    </form>
  </section>
</MainLayout>

<script>
  import { supabase } from "../../lib/supabase";
  import Quill from "quill";

  const quill = new Quill('#editor', { theme: 'snow', modules: { toolbar: [['bold', 'italic', 'underline'], ['code-block', 'link', 'image']] } });
  const form = document.getElementById('projectForm') as HTMLFormElement;
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.innerText = "PROCESSING...";

    const formData = new FormData(form);
    const imageFile = (document.getElementById('imageInput') as HTMLInputElement).files?.[0];
    let imageUrl = "";

    // 1. Upload Image
    if (imageFile) {
      const fileName = `${Date.now()}-${imageFile.name}`;
      const { data, error: uploadError } = await supabase.storage.from('portfolio-assets').upload(`projects/${fileName}`, imageFile);
      if (data) {
        imageUrl = supabase.storage.from('portfolio-assets').getPublicUrl(data.path).data.publicUrl;
      } else if (uploadError) {
        alert("Upload Failed: " + uploadError.message);
      }
    }

    // 2. Insert to Database
    const { error } = await supabase.from('projects').insert([{
      title: formData.get('title'), 
      slug: formData.get('slug'), 
      date: formData.get('date'),
      description: formData.get('description'), 
      tags: (formData.get('tags') as string).split(',').map(t => t.trim().toUpperCase()),
      image_url: imageUrl, 
      content: quill.root.innerHTML,
      demo_url: formData.get('demo_url'), // Link Demo
      repo_url: formData.get('repo_url')  // Link Repo
    }]);

    if (!error) {
      window.location.href = "/admin/dashboard";
    } else {
      alert("Database Error: " + error.message);
      submitBtn.disabled = false;
      submitBtn.innerText = "Upload Project";
    }
  });
  
  // Auto-Slug Logic
  const titleInput = document.getElementsByName('title')[0] as HTMLInputElement;
  const slugInput = document.getElementsByName('slug')[0] as HTMLInputElement;
  
  titleInput?.addEventListener('input', () => {
    slugInput.value = titleInput.value
      .toLowerCase()
      .trim()
      .replace(/[^\w\s-]/g, '')
      .replace(/[\s_-]+/g, '-')
      .replace(/^-+|-+$/g, '');
  });
</script>

<style>
  .input-style { @apply w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-sm text-white focus:border-blue-500/50 transition-all placeholder:text-slate-700 outline-none; }
  .file-input-style { @apply w-full text-[10px] font-mono text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:bg-white/5 file:text-white hover:file:bg-white/10 transition-all cursor-pointer; }
  :global(.ql-snow .ql-stroke) { stroke: #94a3b8 !important; }
  :global(.ql-editor) { font-size: 14px; color: #cbd5e1; }
</style>