---
import MainLayout from "../../layouts/MainLayout.astro";
---

<MainLayout title="Admin | Edit Content">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <section class="relative z-10 max-w-4xl mx-auto px-6 py-20 text-white">
        <div class="mb-10 flex justify-between items-center">
            <div>
                <h1 id="editTitle" class="text-3xl font-bold tracking-tight uppercase font-josefin">Edit Content</h1>
                <p id="editSub" class="text-[10px] tracking-[0.4em] text-slate-600 font-mono uppercase mt-2">Update database entry</p>
            </div>
            <a href="/admin/dashboard" class="text-[10px] font-mono text-slate-500 hover:text-white uppercase tracking-widest border border-white/10 px-4 py-2 rounded-md transition-all">‚Üê Cancel</a>
        </div>

        <form id="editForm" class="card space-y-8 border-white/10 bg-black/40 backdrop-blur-md opacity-0 transition-opacity duration-500 p-1">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-start border-b border-white/5 pb-8">
                <div class="space-y-3">
                    <label class="text-[10px] font-mono text-slate-500 uppercase tracking-widest ml-1">Current Cover</label>
                    <div class="w-full aspect-video rounded-xl bg-white/5 border border-white/10 overflow-hidden relative group">
                        <img id="currentImage" src="" class="w-full h-full object-cover opacity-50 group-hover:opacity-100 transition-opacity" onerror="this.src='https://placehold.co/600x400/1a1a1a/666666?text=No+Image'"/>
                    </div>
                </div>
                <div class="md:col-span-2 space-y-4">
                    <div class="space-y-2">
                        <label class="text-[10px] font-mono text-blue-400 uppercase tracking-widest ml-1">Change Cover Image</label>
                        <input type="file" id="inp-file" accept="image/*" class="file-input-style w-full" />
                        <p class="text-[8px] font-mono text-slate-600 uppercase italic">Leave empty to keep current image</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label class="text-[10px] font-mono text-slate-500 uppercase tracking-widest ml-1">Title</label>
                    <input type="text" name="title" id="inp-title" class="input-style" required />
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-mono text-slate-500 uppercase tracking-widest ml-1">Slug</label>
                    <input type="text" name="slug" id="inp-slug" class="input-style" required />
                </div>
            </div>

            <div id="projectFields" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
                <div class="space-y-2">
                    <label class="text-[10px] font-mono text-blue-400 uppercase tracking-widest ml-1">Live Demo URL</label>
                    <input type="url" name="demo_url" id="inp-demo" class="input-style border-blue-500/20" />
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-mono text-purple-400 uppercase tracking-widest ml-1">Repository URL</label>
                    <input type="url" name="repo_url" id="inp-repo" class="input-style border-purple-500/20" />
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-mono text-slate-500 uppercase tracking-widest ml-1">Tags</label>
                    <input type="text" name="tags" id="inp-tags" placeholder="LARAVEL, REACT" class="input-style" />
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-mono text-slate-500 uppercase tracking-widest ml-1">Date</label>
                    <input type="text" name="date" id="inp-date" class="input-style" />
                </div>
            </div>

            <div class="space-y-2">
                <label class="text-[10px] font-mono text-slate-500 uppercase tracking-widest ml-1">Short Description</label>
                <textarea name="description" id="inp-description" rows="2" class="input-style resize-none"></textarea>
            </div>

            <div class="space-y-4">
                <label class="text-[10px] font-mono text-slate-500 uppercase tracking-widest ml-1">Content Editor</label>
                <div id="editor" class="bg-white/5 border border-white/10 rounded-lg min-h-[400px]"></div>
            </div>

            <button type="submit" id="submitBtn" class="w-full py-4 bg-white text-black font-bold text-[10px] uppercase tracking-[0.3em] rounded-lg hover:bg-blue-600 hover:text-white transition-all active:scale-95">
                Save Changes
            </button>
        </form>
    </section>
</MainLayout>

<script>
    import { supabase } from "../../lib/supabase";
    import Quill from "quill";

    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    const type = urlParams.get('type'); 

    const quill = new Quill('#editor', { theme: 'snow', modules: { toolbar: [['bold', 'italic'], ['code-block', 'image', 'link']] } });
    const form = document.getElementById('editForm') as HTMLFormElement;
    const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
    let oldImageUrl = "";

    async function loadData() {
        if (!id || !type) return window.location.href = "/admin/dashboard";

        if (type === 'projects') document.getElementById('projectFields')?.classList.remove('hidden');

        const { data, error } = await supabase.from(type).select('*').eq('id', id).single();
        
        if (data) {
            (document.getElementById('inp-title') as HTMLInputElement).value = data.title || "";
            (document.getElementById('inp-slug') as HTMLInputElement).value = data.slug || "";
            (document.getElementById('inp-description') as HTMLTextAreaElement).value = data.description || "";
            
            // Set Preview Image
            const imgPreview = document.getElementById('currentImage') as HTMLImageElement;
            oldImageUrl = data.image_url || "";
            imgPreview.src = oldImageUrl;

            if (type === 'projects') {
                (document.getElementById('inp-tags') as HTMLInputElement).value = data.tags?.join(', ') || "";
                (document.getElementById('inp-date') as HTMLInputElement).value = data.date || "";
                (document.getElementById('inp-demo') as HTMLInputElement).value = data.demo_url || "";
                (document.getElementById('inp-repo') as HTMLInputElement).value = data.repo_url || "";
            }
            
            quill.root.innerHTML = data.content || "";
            form.classList.remove('opacity-0');
        }
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitBtn.disabled = true;
        submitBtn.innerText = "UPLOADING & SAVING...";

        const formData = new FormData(form);
        const imageFile = (document.getElementById('inp-file') as HTMLInputElement).files?.[0];
        let finalImageUrl = oldImageUrl;

        // Logic Upload Jika Ada File Baru
        if (imageFile) {
            const fileName = `${Date.now()}-${imageFile.name}`;
            const folder = type === 'projects' ? 'projects' : 'blog-covers';
            const { data: uploadData, error: uploadError } = await supabase.storage
                .from('portfolio-assets')
                .upload(`${folder}/${fileName}`, imageFile);

            if (uploadData) {
                finalImageUrl = supabase.storage.from('portfolio-assets').getPublicUrl(uploadData.path).data.publicUrl;
            } else if (uploadError) {
                alert("Upload Gagal: " + uploadError.message);
            }
        }

        const updateData: any = {
            title: formData.get('title'),
            slug: formData.get('slug'),
            description: formData.get('description'),
            image_url: finalImageUrl,
            content: quill.root.innerHTML
        };

        if (type === 'projects') {
            updateData.tags = (formData.get('tags') as string).split(',').map(t => t.trim().toUpperCase()).filter(t => t !== "");
            updateData.date = formData.get('date');
            updateData.demo_url = formData.get('demo_url');
            updateData.repo_url = formData.get('repo_url');
        }

        const { error } = await supabase.from(type as any).update(updateData).eq('id', id);
        
        if (!error) {
            window.location.href = "/admin/dashboard";
        } else {
            alert(error.message);
            submitBtn.disabled = false;
            submitBtn.innerText = "Save Changes";
        }
    });
    
    // Auto-slug
    const titleInput = document.getElementById('inp-title') as HTMLInputElement;
    const slugInput = document.getElementById('inp-slug') as HTMLInputElement;
    titleInput?.addEventListener('input', () => {
        slugInput.value = titleInput.value.toLowerCase().trim().replace(/[^\w\s-]/g, '').replace(/[\s_-]+/g, '-').replace(/^-+|-+$/g, '');
    });

    loadData();
</script>

<style>
    .input-style { @apply w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-sm text-white focus:border-blue-500/50 transition-all outline-none placeholder:text-slate-700; }
    .file-input-style { @apply text-[10px] font-mono text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:bg-white/10 file:text-white hover:file:bg-white/20 transition-all cursor-pointer; }
    :global(.ql-container.ql-snow) { @apply border-white/10 !important; font-family: inherit; color: #cbd5e1; }
    :global(.ql-toolbar.ql-snow) { @apply border-white/10 bg-white/5 !important; border-top-left-radius: 8px; border-top-right-radius: 8px; }
    :global(.ql-editor) { min-height: 350px; }
</style>